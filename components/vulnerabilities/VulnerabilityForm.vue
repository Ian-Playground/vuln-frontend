<template>
  <UForm
    ref="form"
    :state="state"
    :schema="schema"
    @submit="onSubmit"
    class="space-y-4"
  >
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <UFormField label="Title" name="title" required>
        <UInput v-model="state.title" />
      </UFormField>

      <UFormField label="OWASP Category" name="owasp_category_id" required>
        <USelect
          v-model="state.owasp_category_id"
          :items="owaspCategories"
          placeholder="Select OWASP Category"
          class="w-96"
          :loading="loadingCategories"
        />
      </UFormField>

      <UFormField label="Severity" name="severity" required>
        <USelect
          v-model="state.severity"
          :items="severityOptions"
          placeholder="Select Severity"
          class="w-48"
        />
      </UFormField>

      <UFormField label="Status" name="status" required>
        <USelect
          v-model="state.status"
          :items="statusOptions"
          placeholder="Select Status"
          class="w-48"
        />
      </UFormField>

      <UFormField label="Description" name="description" class="col-span-2" required>
        <UTextarea
          v-model="state.description"
          rows="4"
        />
      </UFormField>

      <UFormField label="Reported By Name" name="reported_by_name" required>
        <UInput v-model="state.reported_by_name" />
      </UFormField>

      <UFormField label="Reported By Email" name="reported_by_email" required>
        <UInput
          v-model="state.reported_by_email"
          type="email"
        />
      </UFormField>

      <UFormField label="Assigned To Name" name="assigned_to_name" required>
        <UInput v-model="state.assigned_to_name" />
      </UFormField>

      <UFormField label="Assigned To Email" name="assigned_to_email" required>
        <UInput
          v-model="state.assigned_to_email"
          type="email"
        />
      </UFormField>
    </div>

    <div class="flex justify-end gap-4 mt-6">
      <UButton
        label="Cancel"
        color="gray"
        variant="ghost"
        @click="handleCancel"
      />
      <UButton
        type="submit"
        :loading="loading"
        :label="isEdit ? 'Update' : 'Create'"
      />
    </div>
  </UForm>
</template>

<script setup lang="ts">
import { ref, reactive, computed, onMounted, onServerPrefetch, onActivated } from 'vue'
import { useAuthStore } from '~/stores/auth'
import { useHttp } from '~/composables/useHttp'
import { navigateTo, useNuxtApp } from '#app'
import * as v from 'valibot'
import type { FormSubmitEvent } from '@nuxt/ui'
import type { Form } from '#ui/types'

interface OwaspCategory {
  id: number
  code: string
  name: string
  description: string
  version: string
  is_active: boolean
  created_at: string
  updated_at: string
}

interface Vulnerability {
  id?: number
  title: string
  description: string
  severity: string
  status: string
  owasp_category_id: number | null
  reported_by_name: string
  reported_by_email: string
  assigned_to_name: string
  assigned_to_email: string
}

interface VulnerabilityFormData {
  title: string
  description: string
  severity: string
  status: string
  owasp_category_id: number | null
  reported_by_name: string
  reported_by_email: string
  assigned_to_name: string
  assigned_to_email: string
}

interface Props {
  initialData?: VulnerabilityFormData
  isEdit?: boolean
}

interface SelectOption {
  label: string
  value: string | number
}

interface ApiError {
  response?: {
    status: number
  }
}

const props = defineProps<Props>()

const emit = defineEmits<{
  submit: []
  cancel: []
}>()

const form = ref<Form<any> | null>(null)
const loading = ref(false)
const loadingCategories = ref(true)
const categories = ref<OwaspCategory[]>([])

const formData = reactive<VulnerabilityFormData>({
  title: props.isEdit ? props.initialData?.title || '' : 'PREFILLED - SQL Injection in User Authentication Module',
  description: props.isEdit ? props.initialData?.description || '' : 'PREFILLED - A critical SQL injection vulnerability was found in the user authentication module.',
  severity: props.isEdit ? props.initialData?.severity || 'Medium' : 'Critical',
  status: props.isEdit ? props.initialData?.status || 'Open' : 'Open',
  owasp_category_id: props.isEdit ? props.initialData?.owasp_category_id || null : 3,
  reported_by_name: props.isEdit ? props.initialData?.reported_by_name || '' : 'John Smith',
  reported_by_email: props.isEdit ? props.initialData?.reported_by_email || '' : 'john.smith@security.com',
  assigned_to_name: props.isEdit ? props.initialData?.assigned_to_name || '' : 'Sarah Johnson',
  assigned_to_email: props.isEdit ? props.initialData?.assigned_to_email || '' : 'sarah.johnson@company.com'
})

const state = reactive<Vulnerability>({
  title: formData.title,
  description: formData.description,
  severity: formData.severity,
  status: formData.status,
  owasp_category_id: formData.owasp_category_id,
  reported_by_name: formData.reported_by_name,
  reported_by_email: formData.reported_by_email,
  assigned_to_name: formData.assigned_to_name,
  assigned_to_email: formData.assigned_to_email
})

const severityOptions = ref<SelectOption[]>([
  { label: 'Critical', value: 'Critical' },
  { label: 'High', value: 'High' },
  { label: 'Medium', value: 'Medium' },
  { label: 'Low', value: 'Low' },
  { label: 'Info', value: 'Info' }
])

const statusOptions = ref<SelectOption[]>([
  { label: 'Open', value: 'Open' },
  { label: 'In Progress', value: 'In Progress' },
  { label: 'Fixed', value: 'Fixed' },
  { label: 'False Positive', value: 'False Positive' }
])

// Fetch OWASP categories
const auth = useAuthStore()
const nuxtApp = useNuxtApp()

const fetchCategories = async (): Promise<void> => {
  console.log('Fetching categories...')
  if (!auth.logged) {
    console.log('Not authenticated, redirecting to login')
    navigateTo('/auth/login')
    return
  }

  try {
    const { data, error } = await useHttp<OwaspCategory[]>('owasp-categories', {
      headers: {
        Authorization: `Bearer ${nuxtApp.$token.value}`
      }
    })
    
    if (error.value) {
      throw error.value
    }

    console.log('Categories data:', data.value)
    categories.value = data.value || []
  } catch (error) {
    const apiError = error as ApiError
    console.error('Error fetching OWASP categories:', error)
    if (apiError.response?.status === 401) {
      auth.reset()
      navigateTo('/auth/login')
    }
  } finally {
    loadingCategories.value = false
  }
}

// Use onMounted for client-side
onMounted(async () => {
  console.log('Component mounted, auth state:', auth.logged)
  if (auth.logged) {
     fetchCategories()
  }
})

const owaspCategories = computed<SelectOption[]>(() => {
  if (!categories.value) return []
  return categories.value.map((category) => ({
    label: `${category.code} - ${category.name}`,
    value: category.id
  }))
})

// Form validation schema
const schema = v.object({
  title: v.pipe(
    v.string(),
    v.minLength(3, 'Title must be at least 3 characters'),
    v.maxLength(255, 'Title must not exceed 255 characters')
  ),
  description: v.pipe(
    v.string(),
    v.minLength(10, 'Description must be at least 10 characters')
  ),
  severity: v.union([
    v.literal('Critical'),
    v.literal('High'),
    v.literal('Medium'),
    v.literal('Low'),
    v.literal('Info')
  ], 'Please select a valid severity level'),
  status: v.union([
    v.literal('Open'),
    v.literal('In Progress'),
    v.literal('Fixed'),
    v.literal('False Positive')
  ], 'Please select a valid status'),
  owasp_category_id: v.number('Please select an OWASP category'),
  reported_by_name: v.pipe(
    v.string(),
    v.minLength(2, 'Reporter name must be at least 2 characters'),
    v.maxLength(255, 'Reporter name must not exceed 255 characters')
  ),
  reported_by_email: v.pipe(
    v.string(),
    v.email('Please enter a valid email address')
  ),
  assigned_to_name: v.pipe(
    v.string(),
    v.minLength(2, 'Reporter name must be at least 2 characters'),
    v.maxLength(255, 'Reporter name must not exceed 255 characters')
  ),
  assigned_to_email: v.pipe(
    v.string(),
    v.email('Please enter a valid email address')
  )
})

type Schema = v.InferOutput<typeof schema>

const onSubmit = async (event: FormSubmitEvent<Schema>): Promise<void> => {
  loading.value = true
  try {
    if (props.isEdit && props.initialData?.id) {
      await useHttp(`vulnerabilities/${props.initialData.id}`, {
        method: 'PUT',
        body: event.data
      })
    } else {
      await useHttp('vulnerabilities', {
        method: 'POST',
        body: event.data
      })
    }
    emit('submit')
    navigateTo('/vulnerabilities')
  } catch (error) {
    const apiError = error as ApiError
    console.error('Error submitting form:', error)
    if (apiError.response?.status === 401) {
      auth.reset()
      navigateTo('/auth/login')
    }
  } finally {
    loading.value = false
  }
}

const handleCancel = () => {
  navigateTo('/vulnerabilities')
}
</script> 